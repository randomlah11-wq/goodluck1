<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>30åˆ†é’Ÿå¥½è¿æŒ‘æˆ˜ âœ¨ï¼ˆFirebase å®æ—¶ç‰ˆï¼‰</title>
  <style>
    :root{ --pink:#ffb4c8; --blue:#8ec8ff; --btn:#ff7f50; --btn2:#ff6b6b; --card:#ffffff; --text:#222; --muted:#666; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family: ui-rounded,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;
      color:var(--text); background:linear-gradient(135deg,var(--pink),var(--blue));
      display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .stars{position:fixed; inset:0; z-index:-1; pointer-events:none}
    .star{position:absolute; width:3px; height:3px; background:#fff; border-radius:50%; opacity:.8; animation:float 10s linear infinite}
    @keyframes float{0%{transform:translateY(0) scale(.6);opacity:.4}50%{transform:translateY(-30px) scale(1);opacity:.9}100%{transform:translateY(0) scale(.6);opacity:.4}}
    .app{ position:relative; z-index:1; width:min(720px,92vw); background:rgba(255,255,255,.18); backdrop-filter:blur(8px);
      border-radius:28px; padding:22px 18px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
    .brand{ text-align:center; color:#fff; font-weight:800; letter-spacing:.5px; margin:4px 0 14px; font-size:clamp(20px,4vw,28px) }
    .page{display:none} .page.active{display:block; animation:fad .28s ease}
    @keyframes fad{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
    .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .btn{ appearance:none; border:0; background:var(--btn); color:#fff; font-weight:700; padding:16px 14px; border-radius:20px;
      box-shadow:0 6px 14px rgba(0,0,0,.15); cursor:pointer; transition:transform .08s ease, filter .08s ease; width:100%; }
    .btn:active{transform:translateY(1px)} .btn.alt{background:var(--btn2)} .btn.ghost{background:#fff; color:#333} .btn.full{grid-column:1/-1}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px}
    .input,textarea{ width:100%; padding:12px 14px; border-radius:16px; border:none; outline:none; background:#fff;
      box-shadow:inset 0 0 0 2px rgba(0,0,0,.05); font-size:16px; }
    textarea{min-height:96px; resize:vertical}
    .card{ background:var(--card); border-radius:18px; padding:14px 12px; box-shadow:0 4px 10px rgba(0,0,0,.08); margin:10px 0; }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .meta{color:var(--muted); font-size:13px}
    .likes{display:flex; align-items:center; gap:6px}
    .stat{text-align:center; color:#fff; font-weight:700; margin-bottom:10px}
    .timer{display:inline-block; padding:.4rem .8rem; background:#00000033; color:#fff; border-radius:999px; font-weight:800}
    .empty{color:#fff; text-align:center; opacity:.9}
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:8px 12px; border-radius:999px; font-size:14px; opacity:0; pointer-events:none}
  </style>
</head>
<body>
  <!-- èƒŒæ™¯æ˜Ÿæ˜Ÿ -->
  <div class="stars" aria-hidden="true"></div>

  <main class="app" role="application">
    <div class="brand">30åˆ†é’Ÿå¥½è¿æŒ‘æˆ˜ âœ¨</div>

    <!-- ä¸»é¡µé¢ -->
    <section id="home" class="page active" aria-labelledby="home-title">
      <h2 id="home-title" class="stat">å‡†å¤‡å¥½æ”¶é›†ä½ çš„å¥½è¿äº†å—ï¼Ÿ</h2>
      <div class="grid">
        <button type="button" class="btn full" onclick="nav('write')">â–¶ï¸ å¼€å§‹æŒ‘æˆ˜</button>
        <button type="button" class="btn" onclick="nav('feed')">ğŸ’¬ å¥½è¿å¢™</button>
        <button type="button" class="btn" onclick="nav('rank')">ğŸ† æ’è¡Œæ¦œ</button>
        <button type="button" class="btn full alt" onclick="nav('how')">â„¹ï¸ æ€ä¹ˆç©ï¼Ÿ</button>
      </div>
    </section>

    <!-- å†™å¥½è¿é¡µ -->
    <section id="write" class="page" aria-labelledby="write-title">
      <div class="row" style="margin-bottom:10px">
        <h2 id="write-title" class="stat" style="margin:0">â³ <span class="timer" id="timer">30:00</span></h2>
        <button type="button" class="btn" onclick="startTimer()">ğŸ•’ å¼€å§‹å€’è®¡æ—¶</button>
      </div>

      <div class="card">
        <div class="toolbar">
          <input id="nick" class="input" placeholder="å¡«ä¸ªæ˜µç§°ï¼ˆå¿…å¡«ï¼‰" />
        </div>
        <textarea id="text" placeholder="æˆ‘çœ‹åˆ°çš„å¥½äº‹æ˜¯..."></textarea>
        <div class="toolbar">
          <button type="button" class="btn" onclick="addLuck()">âœ¨ å†™ä¸‹å¥½è¿ï¼ˆä¸Šä¼ åˆ°äº‘ç«¯ï¼‰</button>
          <button type="button" class="btn alt" onclick="nav('home')">ğŸ”™ å›ä¸»é¡µé¢</button>
        </div>
        <div class="meta">ä½ å·²ç»å†™äº† <b id="mineCount">0</b> æ¡å¥½è¿ ğŸŒˆ</div>
      </div>

      <div id="mineList"></div>
    </section>

    <!-- å¥½è¿å¢™ -->
    <section id="feed" class="page" aria-labelledby="feed-title">
      <h2 id="feed-title" class="stat">ç›®å‰å…±æœ‰ <span id="feedTotal">0</span> æ¡å¥½è¿ âœ¨</h2>
      <div id="feedList"></div>
      <div class="toolbar">
        <button type="button" class="btn alt" onclick="nav('home')">ğŸ”™ å›ä¸»é¡µé¢</button>
      </div>
    </section>

    <!-- æ’è¡Œæ¦œ -->
    <section id="rank" class="page" aria-labelledby="rank-title">
      <h2 id="rank-title" class="stat">æœ¬æ¬¡æŒ‘æˆ˜ Â· è£èª‰æ¦œ</h2>
      <div id="rankList" class="card"></div>
      <div class="toolbar">
        <button type="button" class="btn alt" onclick="nav('home')">ğŸ”™ å›ä¸»é¡µé¢</button>
      </div>
    </section>

    <!-- è¯´æ˜é¡µ -->
    <section id="how" class="page" aria-labelledby="how-title">
      <div class="card">
        <h3 id="how-title">æ€ä¹ˆç©ï¼Ÿ</h3>
        <p>åœ¨30åˆ†é’Ÿå†…å†™ä¸‹ä½ çœ‹åˆ°çš„æ‰€æœ‰å¥½äº‹ã€‚æ¯å†™ä¸€æ¡ï¼Œå°±æ›´é è¿‘å¹¸è¿ï¼ä½ ä¹Ÿå¯ä»¥ç»™åˆ«äººå†™çš„å¥½è¿ç‚¹èµ ğŸ’–ï¼ˆæ‰€æœ‰æ•°æ®å®æ—¶åŒæ­¥ï¼‰</p>
      </div>
      <div class="toolbar">
        <button type="button" class="btn alt" onclick="nav('home')">ğŸ”™ å›ä¸»é¡µé¢</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase CDNï¼ˆCompat ç‰ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    /* === ä½ çš„ Firebase é…ç½®ï¼ˆæ¥è‡ªä½ æä¾›çš„é¡¹ç›®ä¿¡æ¯ï¼›å·²è¡¥å…… databaseURLï¼‰ === */
    const firebaseConfig = {
      apiKey: "AIzaSyA4CheNGxYJnn9q2HzcrV4MU0h1d9nSVeM",
      authDomain: "goodluck1314-bb364.firebaseapp.com",
      databaseURL: "https://goodluck1314-bb364-default-rtdb.firebaseio.com",
      projectId: "goodluck1314-bb364",
      storageBucket: "goodluck1314-bb364.firebasestorage.app",
      messagingSenderId: "786667392503",
      appId: "1:786667392503:web:e5893642e903e66d9632f2",
      measurementId: "G-K5MMDJSM6V"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    /** ================== åŸºç¡€ UI çŠ¶æ€ ================== **/
    const pages = ["home","write","feed","rank","how"];
    let ticking=false, left=30*60, timerId=null;
    const state = {
      nick: localStorage.getItem("luck_nick") || "",
      lucks: new Map() // id -> {id,nick,text,likes,createdAt}
    };
    const qs = id => document.getElementById(id);
    const toast = (msg)=>{ const t=qs("toast"); t.textContent=msg; t.style.opacity=1; clearTimeout(t._h); t._h=setTimeout(()=>t.style.opacity=0,1400); };

    function nav(id){
      pages.forEach(p => qs(p).classList.remove("active"));
      qs(id).classList.add("active");
      if(id==="feed") renderFeed();
      if(id==="rank") renderRank();
    }

    // åˆå§‹åŒ–æ˜µç§°
    qs("nick").value = state.nick;
    qs("nick").addEventListener("change", e=>{
      state.nick = e.target.value.trim();
      localStorage.setItem("luck_nick", state.nick);
      renderMine();
    });

    /** ================== å€’è®¡æ—¶ ================== **/
    const fmt = s => `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
    function tick(){ if(!ticking) return; if(left<=0){ ticking=false; clearInterval(timerId); alert("æ—¶é—´åˆ°ï¼å»çœ‹çœ‹å¥½è¿å¢™å§ï½"); return;} left--; qs("timer").textContent = fmt(left); }
    function startTimer(){ if(ticking) return; ticking=true; if(left<=0) left=30*60; qs("timer").textContent=fmt(left); timerId=setInterval(tick,1000); }

    /** ================== å†™å¥½è¿ -> Firebase ================== **/
    function addLuck(){
      const nick = (qs("nick").value||"").trim();
      const text = (qs("text").value||"").trim();
      if(!nick){ alert("è¯·å…ˆå¡«å†™æ˜µç§°ï½"); qs("nick").focus(); return; }
      if(!text){ alert("è¯·å…ˆå†™ç‚¹å¥½è¿å†…å®¹ï½"); qs("text").focus(); return; }

      state.nick = nick; localStorage.setItem("luck_nick", nick);
      const data = { nick, text, likes: 0, createdAt: Date.now() };

      // push å†™å…¥ï¼›å¤±è´¥ä¼šæç¤ºé”™è¯¯
      db.ref("lucks").push(data).then(()=>{
        qs("text").value = "";
        toast("å·²æäº¤ âœ…");
        renderMine(); // æœ¬åœ°è¿‡æ»¤æˆ‘çš„åˆ—è¡¨
      }).catch(err=>{
        console.error("å†™å…¥å¤±è´¥ï¼š", err);
        alert("æäº¤å¤±è´¥ï¼šè¯·æ£€æŸ¥ç½‘ç»œã€databaseURL æˆ–æ•°æ®åº“è§„åˆ™ã€‚");
      });
    }

    /** ================== å®æ—¶è®¢é˜…ï¼ˆæ›´ç¨³ï¼šchild_added / child_changedï¼‰ ================== **/
    const ref = db.ref("lucks");

    // æ–°å¢
    ref.on("child_added", snap=>{
      const v = snap.val() || {};
      state.lucks.set(snap.key, { id:snap.key, ...v });
      qs("feedTotal").textContent = state.lucks.size;
      if(qs("feed").classList.contains("active")) renderFeed();
      renderMine();
      if(qs("rank").classList.contains("active")) renderRank();
    });

    // å˜æ›´ï¼ˆç‚¹èµç­‰ï¼‰
    ref.on("child_changed", snap=>{
      const v = snap.val() || {};
      state.lucks.set(snap.key, { id:snap.key, ...v });
      const likeEl = qs(`likes-${snap.key}`);
      if(likeEl){ likeEl.textContent = v.likes||0; likeEl.animate([{transform:"scale(1)"},{transform:"scale(1.2)"},{transform:"scale(1)"}],{duration:220}); }
      if(qs("rank").classList.contains("active")) renderRank();
    });

    // ï¼ˆå¯é€‰ï¼‰åˆ é™¤
    ref.on("child_removed", snap=>{
      state.lucks.delete(snap.key);
      qs("feedTotal").textContent = state.lucks.size;
      if(qs("feed").classList.contains("active")) renderFeed();
      renderMine();
      if(qs("rank").classList.contains("active")) renderRank();
    });

    /** ================== ç‚¹èµï¼ˆäº‹åŠ¡ï¼Œé¿å…å¹¶å‘è¦†ç›–ï¼‰ ================== **/
    const likeCooldown = new Set();
    function like(id){
      if(likeCooldown.has(id)) return;
      likeCooldown.add(id);
      db.ref(`lucks/${id}/likes`).transaction(cur => (cur||0)+1, (err, committed)=>{
        setTimeout(()=>likeCooldown.delete(id), 400);
        if(err){ console.error(err); toast("ç‚¹èµå¤±è´¥ âŒ"); }
        else if(committed){ /* æˆåŠŸåä¼šè§¦å‘ child_changed è‡ªåŠ¨æ›´æ–° */ }
      });
    }

    /** ================== æ¸²æŸ“ï¼šæˆ‘çš„åˆ—è¡¨ ================== **/
    function renderMine(){
      const mine = [...state.lucks.values()].filter(l => l.nick === state.nick);
      qs("mineCount").textContent = mine.length;
      const wrap = qs("mineList"); wrap.innerHTML = "";
      if(mine.length===0){ wrap.innerHTML = `<div class="empty">è¿˜æ²¡æœ‰å†™è®°å½•ï½ å¼€å§‹å†™ä¸‹ç¬¬ä¸€æ¡å¥½è¿å§ï¼</div>`; return; }
      mine.sort((a,b)=>b.createdAt-a.createdAt).forEach(l=>{
        const div=document.createElement("div"); div.className="card";
        div.innerHTML = `
          <div class="row">
            <div>
              <div><b>${esc(l.nick)}</b> ï¼š${esc(l.text)}</div>
              <div class="meta">ğŸ’– å·²ä¿å­˜</div>
            </div>
            <div class="likes"><span>â¤ï¸</span><span>${l.likes||0}</span></div>
          </div>`;
        wrap.appendChild(div);
      });
    }

    /** ================== æ¸²æŸ“ï¼šå¥½è¿å¢™ ================== **/
    function renderFeed(){
      const wrap = qs("feedList"); wrap.innerHTML = "";
      const list = [...state.lucks.values()].sort((a,b)=>b.createdAt-a.createdAt);
      if(list.length===0){ wrap.innerHTML = `<div class="card meta">å¤§å®¶è¿˜æ²¡å¼€å§‹å†™ï½ ä½ æ¥å½“ç¬¬ä¸€ä½å‘èµ·è€…å§ï¼</div>`; return; }
      list.forEach(l=>{
        const div=document.createElement("div"); div.className="card";
        div.innerHTML = `
          <div class="row">
            <div>
              <div>ğŸ’¬ ${esc(l.text)}</div>
              <div class="meta">ğŸ§ æ¥è‡ªï¼š${esc(l.nick)}</div>
            </div>
            <div class="likes">
              <button type="button" class="btn ghost" style="padding:8px 10px; border-radius:999px" onclick="like('${l.id}')">ç‚¹èµ ğŸ’–</button>
              <span id="likes-${l.id}" aria-live="polite">${l.likes||0}</span>
            </div>
          </div>`;
        wrap.appendChild(div);
      });
    }

    /** ================== æ¸²æŸ“ï¼šæ’è¡Œæ¦œï¼ˆæŒ‰â€œå†™çš„æ¡æ•°â€ï¼‰ ================== **/
    function renderRank(){
      const map=new Map();
      state.lucks.forEach(l => map.set(l.nick,(map.get(l.nick)||0)+1));
      const arr=[...map.entries()].map(([nick,count])=>({nick,count})).sort((a,b)=>b.count-a.count);
      const titleOf=i=> (["å¥½è¿å¥³ç¥","ç¬‘å®¹è¾¾äºº","å¹¸è¿æ˜Ÿ","é˜³å…‰ä½¿è€…","èƒ½é‡è¡¥ç»™ç«™"][i] || "æ´»åŠ›æ»¡æ»¡");
      const wrap=qs("rankList"); wrap.innerHTML="";
      if(arr.length===0){ wrap.innerHTML=`<div class="meta">è¿˜æ²¡æœ‰æ•°æ®ï½ å»â€œå†™å¥½è¿â€é¡µé¢å¼€å§‹å§ï¼</div>`; return; }
      arr.forEach((u,i)=>{
        const row=document.createElement("div"); row.className="row"; row.style.margin="8px 0";
        row.innerHTML = `<div><b>${i+1}ï¸âƒ£ ${esc(u.nick)}</b></div><div class="meta">å†™äº† <b>${u.count}</b> æ¡ï½œç§°å·ï¼š${titleOf(i)}</div>`;
        wrap.appendChild(row);
      });
    }

    /** ================== å°å·¥å…· ================== **/
    const esc = s => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    (function initStars(){
      const box=document.querySelector(".stars");
      for(let i=0;i<80;i++){
        const st=document.createElement("div"); st.className="star";
        st.style.top=(Math.random()*100)+"%"; st.style.left=(Math.random()*100)+"%";
        st.style.animationDuration=(6+Math.random()*8)+"s"; st.style.opacity=(0.4+Math.random()*0.6).toFixed(2);
        box.appendChild(st);
      }
    })();
  </script>
</body>
</html>
